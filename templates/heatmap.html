<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <style>
      rect.bordered {
        stroke: #E6E6E6;
        stroke-width:2px;
      }

      text.mono {
        font-size: 9pt;
        font-family: Consolas, courier;
        fill: #000;
      }

      text.axis-workweek {
        fill: #000;
      }

      text.axis-worktime {
        fill: #000;
      }
    </style>
    <title>Heatmap</title>
    <script src='../static/d3.min.js'></script>
  </head>
  <body>
    <h1>Premature Birth Rate 2014</h1>

      <p>This heat map represents ~3.9 million birth records (~5Gb plain text) collected by the CDC in 2014.
      (See <a href='http://www.cdc.gov/nchs/data_access/vitalstatsonline.htm'>Vital Statistics Data</a> for details).
      The dataset contains significant amounts of ethnographic and medical details on the births occurring in the US,
      including details on the estimated gestation period for each birth. Defining a premature birth as one occurring
      before 37 weeks gestation, I compiled rates of premature birth by the enthic origins of the mother and state of mothers residence.
      Blank tiles indicate there was insufficient data for the demographic.
      </p>


    <div id="chart"></div>
    <div id="dataset-picker">

      <p>Racial disparities in premature birth rate are clearly evident but are not consistent from state to state.
        Notice that the rate of premature birth for African Americans living in Louisiana (LA) is more then twice
        the rate of the same demographic in Oregon (OR) or North Dakota (ND) for example.
      </p>

      <p>The CDC collects significant amounts of background information on the pregnancy, including the
         how long into the pregnancy the mother was first evaluated by a physician (although unfortunatly not how freqently). I hypothized
         premature birth rate might be correlated with this mean delay to first checkup as a proxy of access to healthcare.
        See preliminary health care analysis below.
      </p>

    </div>

      </div>
    <form method='POST' action='index'>
      <p>
        See preliminary health care analysis: <input   type='submit' name='submit' value='healthcare'></input>
      </p>
      <p>
       See Preliminary poverty analysis: <input   type='submit' name='submit' value='poverty'></input>
      </p>
  <div>

    <script type="text/javascript">
      var margin = { top: 50, right: 20, bottom: 100, left: 70},
          width = 1250 - margin.left - margin.right,
          height = 250 - margin.top - margin.bottom,
          gridSize = Math.floor(width / 51),
          legendElementWidth = gridSize*2,
          buckets = 9,
          colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"], // alternatively colorbrewer.YlGnBu[9]
          days = ["Native A.", "Asian", "African", "European"],
          times = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'DC', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'];


      var svg = d3.select("#chart").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var dayLabels = svg.selectAll(".dayLabel")
          .data(days)
          .enter().append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("y", function (d, i) { return i * gridSize; })
            .style("text-anchor", "end")
            .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
            .attr("class", function (d, i) { return ((i >= 0 && i <= 4) ? "dayLabel mono axis axis-workweek" : "dayLabel mono axis"); });

      var timeLabels = svg.selectAll(".timeLabel")
          .data(times)
          .enter().append("text")
            .text(function(d) { return d; })
            .attr("x", function(d, i) { return i * gridSize; })
            .attr("y", 0)
            .style("text-anchor", "middle")
            .attr("transform", "translate(" + gridSize / 2 + ", -6)")
            .attr("class", function(d, i) { return ((i >= 7 && i <= 16) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });

      var heatmapChart = function(tsvFile) {
        d3.csv(tsvFile,
        function(d) {
          return {
            day: +d.day,
            hour: +d.hour,
            value: +d.value
          };
        },
        function(error, data) {
          var colorScale = d3.scale.quantile()
              .domain([3, buckets - 1, d3.max(data, function (d) { return d.value; })])
              .range(colors);

          var cards = svg.selectAll(".hour")
              .data(data, function(d) {return d.day+':'+d.hour;});

          cards.append("title");

          cards.enter().append("rect")
              .filter( function(d){ return d.value > 0; } )
              .attr("x", function(d) { return (d.hour ) * gridSize; })
              .attr("y", function(d) { return (d.day ) * gridSize; })
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("class", "hour bordered")
              .attr("width", gridSize)
              .attr("height", gridSize)
              .style("fill", function(d) { if (+d.value > 2. ) {return colors[0];} else{return '#FFFFFF';} });

          cards.transition().duration(1000)
              .style("fill", function(d){ if( +d.value > .1){ return colorScale(d.value); } else {return '#FFFFFF';} } );

          cards.select("title").text(function(d) { return d.value; });

          cards.exit().remove();

          var legend = svg.selectAll(".legend")
              .data([0].concat(colorScale.quantiles()), function(d) { return d; });

          legend.enter().append("g")
              .attr("class", "legend");

          legend.append("rect")
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height)
            .attr("width", legendElementWidth)
            .attr("height", gridSize / 2)
            .style("fill", function(d, i) { return colors[i]; });

          legend.append("text")
            .attr("class", "mono")
            .text(function(d) { return "â‰¥ " + Math.round(d); })
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height + gridSize);

          legend.exit().remove();

        });

        svg.append("text")
            .attr("class", 'timeLabel mono axis' )
            .text("Percentage of births that are premature.")
            .attr("x", 60)
            .attr("y", 140);
      };

      heatmapChart('/static/heat1.csv');


    </script>
  </body>
</html>
